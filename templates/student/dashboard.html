{% extends 'base.html' %}
{% load static %}

{% block title %}Student Portal - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-0">Student Dashboard</h1>
            <p class="text-muted">Track your academic progress, attendance, and fees</p>
        </div>
        <div class="col-md-4 text-end">
            <button id="refresh-btn" class="btn btn-outline-primary">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container"></div>

    <!-- Loading State -->
    <div id="loading-state">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading your dashboard...</p>
        </div>
    </div>

    <!-- Content Container -->
    <div id="content-container" class="d-none">
        <!-- Overview Cards -->
        <div class="row mb-4" id="overview-cards">
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <small class="text-muted d-block">Attendance</small>
                                <h4 class="mb-0" id="attendance-pct">--</h4>
                            </div>
                            <div class="text-primary" style="font-size: 2rem;">
                                <i class="bi bi-calendar-check"></i>
                            </div>
                        </div>
                        <small class="text-muted" id="attendance-label">Present</small>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <small class="text-muted d-block">Average Score</small>
                                <h4 class="mb-0" id="avg-score">--</h4>
                            </div>
                            <div class="text-success" style="font-size: 2rem;">
                                <i class="bi bi-graph-up"></i>
                            </div>
                        </div>
                        <small class="text-muted">Overall Performance</small>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <small class="text-muted d-block">Fees Paid</small>
                                <h4 class="mb-0" id="fees-paid">--</h4>
                            </div>
                            <div class="text-info" style="font-size: 2rem;">
                                <i class="bi bi-receipt"></i>
                            </div>
                        </div>
                        <small class="text-muted" id="fees-label">Payment Status</small>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <small class="text-muted d-block">Outstanding</small>
                                <h4 class="mb-0" id="fees-outstanding">--</h4>
                            </div>
                            <div class="text-warning" style="font-size: 2rem;">
                                <i class="bi bi-exclamation-circle"></i>
                            </div>
                        </div>
                        <small class="text-muted">Amount Due</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="grades-tab" data-bs-toggle="tab" data-bs-target="#grades-content" type="button" role="tab">
                    <i class="bi bi-pencil-square"></i> Grades
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance-content" type="button" role="tab">
                    <i class="bi bi-calendar-check"></i> Attendance
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="fees-tab" data-bs-toggle="tab" data-bs-target="#fees-content" type="button" role="tab">
                    <i class="bi bi-receipt"></i> Fees & Payments
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications-content" type="button" role="tab">
                    <i class="bi bi-bell"></i> Notifications <span class="badge bg-danger" id="notif-badge" style="display: none;"></span>
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Grades Tab -->
            <div class="tab-pane fade show active" id="grades-content" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Exam Results & Transcripts</h5>
                    </div>
                    <div class="card-body">
                        <div id="grades-loading" class="text-center py-5">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="grades-content-container" class="d-none">
                            <div id="grades-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div class="tab-pane fade" id="attendance-content" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Attendance Records</h5>
                            </div>
                            <div class="card-body">
                                <div id="attendance-loading" class="text-center py-5">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div id="attendance-content-container" class="d-none">
                                    <div id="attendance-records"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Attendance Summary</h5>
                            </div>
                            <div class="card-body">
                                <div id="attendance-summary"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fees Tab -->
            <div class="tab-pane fade" id="fees-content" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Current Invoices</h5>
                            </div>
                            <div class="card-body">
                                <div id="invoices-loading" class="text-center py-5">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div id="invoices-content-container" class="d-none">
                                    <div id="invoices-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Payment Summary</h5>
                            </div>
                            <div class="card-body">
                                <div id="payment-summary"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment History -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Payment History</h5>
                    </div>
                    <div class="card-body">
                        <div id="payments-loading" class="text-center py-5">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="payments-content-container" class="d-none">
                            <div id="payment-history"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div class="tab-pane fade" id="notifications-content" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Your Notifications</h5>
                        <button id="clear-notifs-btn" class="btn btn-sm btn-outline-secondary" style="display: none;">
                            Clear All
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="notifications-loading" class="text-center py-5">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="notifications-content-container" class="d-none">
                            <div id="notifications-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15) !important;
}

.nav-tabs .nav-link {
    color: #6c757d;
    border-bottom: 2px solid transparent;
}

.nav-tabs .nav-link.active {
    color: #0d6efd;
    background-color: transparent;
    border-color: transparent;
    border-bottom-color: #0d6efd;
}

.badge {
    margin-left: 0.5rem;
}

.table-responsive {
    border-radius: 0.25rem;
}

.grade-badge {
    font-size: 1.25rem;
    font-weight: bold;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
}

.grade-a { background-color: #28a745; color: white; }
.grade-b { background-color: #17a2b8; color: white; }
.grade-c { background-color: #ffc107; color: black; }
.grade-d { background-color: #fd7e14; color: white; }
.grade-f { background-color: #dc3545; color: white; }
</style>

<script>
const API_BASE = '/api/student';

document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
    
    document.getElementById('refresh-btn').addEventListener('click', loadDashboard);
});

function loadDashboard() {
    showLoading(true);
    
    Promise.all([
        fetchAPI('overview'),
        fetchAPI('grades'),
        fetchAPI('attendance'),
        fetchAPI('fees'),
        fetchAPI('notifications')
    ]).then(results => {
        if (results.every(r => r)) {
            displayOverview(results[0]);
            displayGrades(results[1]);
            displayAttendance(results[2]);
            displayFees(results[3]);
            displayNotifications(results[4]);
            showContent(true);
        }
    }).catch(error => {
        showAlert('Error loading dashboard: ' + error, 'danger');
    }).finally(() => {
        showLoading(false);
    });
}

function fetchAPI(endpoint) {
    return fetch(`${API_BASE}/${endpoint}/`)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .catch(error => {
            console.error(`Error fetching ${endpoint}:`, error);
            return null;
        });
}

function displayOverview(data) {
    if (!data.success) return;
    
    const d = data.data;
    document.getElementById('attendance-pct').textContent = d.attendance_percentage + '%';
    document.getElementById('avg-score').textContent = d.average_score;
    document.getElementById('fees-paid').textContent = formatCurrency(d.fees_paid);
    document.getElementById('fees-outstanding').textContent = formatCurrency(d.fees_outstanding);
}

function displayGrades(data) {
    if (!data.success) return;
    
    const gradesContainer = document.getElementById('grades-list');
    const gradesLoadingDiv = document.getElementById('grades-loading');
    const gradesContentDiv = document.getElementById('grades-content-container');
    
    if (data.data.length === 0) {
        gradesContainer.innerHTML = '<p class="text-muted">No grades available yet.</p>';
        gradesLoadingDiv.classList.add('d-none');
        gradesContentDiv.classList.remove('d-none');
        return;
    }
    
    let html = '';
    data.data.forEach(exam => {
        html += `
            <div class="mb-4">
                <h6 class="text-primary border-bottom pb-2">${exam.exam_session} - ${exam.term}</h6>
                <small class="text-muted d-block mb-3">${new Date(exam.date).toLocaleDateString()}</small>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Subject</th>
                                <th>Score</th>
                                <th>Grade</th>
                                <th>Comments</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        exam.subjects.forEach(subject => {
            const gradeClass = `grade-${subject.grade.toLowerCase()}`;
            html += `
                <tr>
                    <td>${subject.subject}</td>
                    <td>${subject.score}</td>
                    <td><span class="badge grade-badge ${gradeClass}">${subject.grade}</span></td>
                    <td><small>${subject.comments || '-'}</small></td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    });
    
    gradesContainer.innerHTML = html;
    gradesLoadingDiv.classList.add('d-none');
    gradesContentDiv.classList.remove('d-none');
}

function displayAttendance(data) {
    if (!data.success) return;
    
    const stats = data.data.statistics;
    const records = data.data.records;
    
    // Summary
    const summaryDiv = document.getElementById('attendance-summary');
    summaryDiv.innerHTML = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Present</span>
                <strong>${stats.present}</strong>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Absent</span>
                <strong>${stats.absent}</strong>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Late</span>
                <strong>${stats.late}</strong>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">Excused</span>
                <strong>${stats.excused}</strong>
            </div>
            <hr>
            <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted"><strong>Percentage</strong></span>
                <strong class="text-success">${stats.percentage}%</strong>
            </div>
        </div>
    `;
    
    // Records
    const recordsDiv = document.getElementById('attendance-records');
    if (records.length === 0) {
        recordsDiv.innerHTML = '<p class="text-muted">No attendance records yet.</p>';
    } else {
        let html = '<div class="table-responsive"><table class="table table-sm table-hover"><thead class="table-light"><tr><th>Date</th><th>Status</th><th>Remarks</th></tr></thead><tbody>';
        records.forEach(record => {
            const statusBadge = {
                'present': '<span class="badge bg-success">Present</span>',
                'absent': '<span class="badge bg-danger">Absent</span>',
                'late': '<span class="badge bg-warning">Late</span>',
                'excused': '<span class="badge bg-info">Excused</span>'
            }[record.status] || record.status;
            
            html += `
                <tr>
                    <td>${new Date(record.date).toLocaleDateString()}</td>
                    <td>${statusBadge}</td>
                    <td><small>${record.remarks || '-'}</small></td>
                </tr>
            `;
        });
        html += '</tbody></table></div>';
        recordsDiv.innerHTML = html;
    }
    
    document.getElementById('attendance-loading').classList.add('d-none');
    document.getElementById('attendance-content-container').classList.remove('d-none');
}

function displayFees(data) {
    if (!data.success) return;
    
    const summary = data.data.summary;
    const invoices = data.data.invoices;
    const paymentHistory = data.data.payment_history;
    
    // Summary
    const summaryDiv = document.getElementById('payment-summary');
    summaryDiv.innerHTML = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Total Invoiced</span>
                <strong>${formatCurrency(summary.total_invoiced)}</strong>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Total Paid</span>
                <strong class="text-success">${formatCurrency(summary.total_paid)}</strong>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">Outstanding</span>
                <strong class="text-danger">${formatCurrency(summary.total_outstanding)}</strong>
            </div>
        </div>
    `;
    
    // Invoices
    const invoicesDiv = document.getElementById('invoices-list');
    if (invoices.length === 0) {
        invoicesDiv.innerHTML = '<p class="text-muted">No invoices yet.</p>';
    } else {
        let html = '';
        invoices.forEach(invoice => {
            const statusBadge = {
                'paid': '<span class="badge bg-success">Paid</span>',
                'partial': '<span class="badge bg-warning">Partial</span>',
                'pending': '<span class="badge bg-danger">Pending</span>'
            }[invoice.status] || invoice.status;
            
            html += `
                <div class="card mb-2 border-0 bg-light">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="mb-1"><strong>${invoice.description}</strong></p>
                                <small class="text-muted">${new Date(invoice.created_at).toLocaleDateString()}</small>
                            </div>
                            <div class="text-end">
                                <p class="mb-1">${statusBadge}</p>
                                <small class="text-muted">KES ${invoice.total_amount.toFixed(2)}</small>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Paid: <strong>KES ${invoice.paid_amount.toFixed(2)}</strong> | Outstanding: <strong>KES ${invoice.outstanding.toFixed(2)}</strong></small>
                        </div>
                    </div>
                </div>
            `;
        });
        invoicesDiv.innerHTML = html;
    }
    
    // Payment History
    const historyDiv = document.getElementById('payment-history');
    if (paymentHistory.length === 0) {
        historyDiv.innerHTML = '<p class="text-muted">No payments yet.</p>';
    } else {
        let html = '<div class="table-responsive"><table class="table table-sm table-hover"><thead class="table-light"><tr><th>Date</th><th>Amount</th><th>Method</th><th>Invoice</th></tr></thead><tbody>';
        paymentHistory.forEach(payment => {
            html += `
                <tr>
                    <td>${new Date(payment.date).toLocaleDateString()}</td>
                    <td><strong>KES ${payment.amount.toFixed(2)}</strong></td>
                    <td><small>${payment.method}</small></td>
                    <td><small>${payment.invoice}</small></td>
                </tr>
            `;
        });
        html += '</tbody></table></div>';
        historyDiv.innerHTML = html;
    }
    
    document.getElementById('invoices-loading').classList.add('d-none');
    document.getElementById('invoices-content-container').classList.remove('d-none');
    document.getElementById('payments-loading').classList.add('d-none');
    document.getElementById('payments-content-container').classList.remove('d-none');
}

function displayNotifications(data) {
    if (!data.success) return;
    
    const notifications = data.data;
    const notifDiv = document.getElementById('notifications-list');
    
    if (notifications.length === 0) {
        notifDiv.innerHTML = '<p class="text-muted">No notifications.</p>';
    } else {
        let html = '';
        const unreadCount = notifications.filter(n => !n.is_read).length;
        
        if (unreadCount > 0) {
            document.getElementById('notif-badge').textContent = unreadCount;
            document.getElementById('notif-badge').style.display = 'inline-block';
        }
        
        notifications.forEach(notif => {
            const readClass = notif.is_read ? '' : 'bg-light border-start border-primary border-3';
            html += `
                <div class="card mb-2 border-0 ${readClass}">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <p class="mb-1"><strong>${notif.title}</strong></p>
                                <p class="mb-1 text-muted" style="font-size: 0.9rem;">${notif.message}</p>
                                <small class="text-muted">${new Date(notif.created_at).toLocaleDateString()}</small>
                            </div>
                            <span class="badge ${notif.is_read ? 'bg-secondary' : 'bg-primary'}">
                                ${notif.is_read ? 'Read' : 'New'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });
        notifDiv.innerHTML = html;
    }
    
    document.getElementById('notifications-loading').classList.add('d-none');
    document.getElementById('notifications-content-container').classList.remove('d-none');
}

function showLoading(show) {
    const loader = document.getElementById('loading-state');
    if (show) {
        loader.classList.remove('d-none');
    } else {
        loader.classList.add('d-none');
    }
}

function showContent(show) {
    const content = document.getElementById('content-container');
    if (show) {
        content.classList.remove('d-none');
    } else {
        content.classList.add('d-none');
    }
}

function showAlert(message, type = 'info') {
    const alertDiv = document.getElementById('alert-container');
    const alertHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    alertDiv.innerHTML = alertHTML;
    setTimeout(() => {
        alertDiv.innerHTML = '';
    }, 5000);
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-KE', {
        style: 'currency',
        currency: 'KES'
    }).format(amount);
}
</script>
{% endblock %}
