{% extends 'base.html' %}
{% load static %}

{% block title %}Parent Portal - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-0">Parent Portal</h1>
            <p class="text-muted">Manage your child's school information</p>
        </div>
        <div class="col-md-4 text-end">
            <button id="refresh-btn" class="btn btn-outline-primary">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container"></div>

    <!-- Loading State -->
    <div id="loading-state" class="d-none">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading your child's information...</p>
        </div>
    </div>

    <!-- Content Container -->
    <div id="content-container" class="d-none">
        <!-- Student Selection -->
        <div class="row mb-4">
            <div class="col-md-12">
                <label for="student-select" class="form-label">Select Child</label>
                <select id="student-select" class="form-select">
                    <option value="">Loading students...</option>
                </select>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="fees-tab" data-bs-toggle="tab" data-bs-target="#fees-content" type="button" role="tab">
                    <i class="bi bi-receipt"></i> Fees & Payments
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance-content" type="button" role="tab">
                    <i class="bi bi-calendar-check"></i> Attendance
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="exams-tab" data-bs-toggle="tab" data-bs-target="#exams-content" type="button" role="tab">
                    <i class="bi bi-pencil-square"></i> Exam Results
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications-content" type="button" role="tab">
                    <i class="bi bi-bell"></i> Notifications
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Fees Tab -->
            <div class="tab-pane fade show active" id="fees-content" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Fee Structure & Payments</h5>
                            </div>
                            <div class="card-body">
                                <div id="fees-loading" class="text-center py-5">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div id="fees-content-container" class="d-none">
                                    <div id="fees-list"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment History -->
                        <div class="card border-0 shadow-sm mt-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Payment History</h5>
                            </div>
                            <div class="card-body">
                                <div id="payments-loading" class="text-center py-5">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div id="payments-content-container" class="d-none">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Amount</th>
                                                <th>Reference</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="payments-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Sidebar -->
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm bg-light">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Summary</h6>
                                <div class="mb-3">
                                    <label class="small text-muted">Total Fees</label>
                                    <p class="h5 mb-0" id="total-fees">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted">Amount Paid</label>
                                    <p class="h5 mb-0 text-success" id="amount-paid">-</p>
                                </div>
                                <div>
                                    <label class="small text-muted">Outstanding</label>
                                    <p class="h5 mb-0 text-danger" id="outstanding">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Status -->
                        <div class="card border-0 shadow-sm mt-3">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Payment Status</h6>
                                <div id="payment-status">
                                    <span class="badge bg-warning">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div class="tab-pane fade" id="attendance-content" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Attendance Record</h5>
                    </div>
                    <div class="card-body">
                        <div id="attendance-loading" class="text-center py-5">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="attendance-content-container" class="d-none">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <p class="text-muted mb-1">Present Days</p>
                                            <h4 id="days-present">-</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <p class="text-muted mb-1">Absent Days</p>
                                            <h4 id="days-absent">-</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <p class="text-muted mb-1">Total Days</p>
                                            <h4 id="days-total">-</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <p class="text-muted mb-1">Attendance %</p>
                                            <h4 id="attendance-percent">-</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div id="attendance-chart" class="mt-3" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exams Tab -->
            <div class="tab-pane fade" id="exams-content" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Exam Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="exams-loading" class="text-center py-5">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="exams-content-container" class="d-none">
                            <div id="exams-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div class="tab-pane fade" id="notifications-content" role="tabpanel">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div id="notifications-loading" class="text-center py-5">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="notifications-content-container" class="d-none">
                            <div id="notifications-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js for attendance chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // Parent Portal API Consumer
    class ParentPortalApp {
        constructor() {
            this.studentId = null;
            this.apiBase = '/api/parent';
            this.init();
        }

        init() {
            this.setupEventListeners();
            this.loadStudents();
        }

        setupEventListeners() {
            document.getElementById('student-select').addEventListener('change', (e) => {
                this.studentId = e.target.value;
                if (this.studentId) {
                    this.loadAllData();
                }
            });

            document.getElementById('refresh-btn').addEventListener('click', () => {
                if (this.studentId) {
                    this.loadAllData();
                }
            });
        }

        showAlert(message, type = 'danger') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        async loadStudents() {
            try {
                document.getElementById('loading-state').classList.remove('d-none');
                const response = await fetch(`${this.apiBase}/students/`);
                const data = await response.json();
                
                const select = document.getElementById('student-select');
                select.innerHTML = '<option value="">Select a child...</option>';
                
                data.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.first_name} ${student.last_name}`;
                    select.appendChild(option);
                });

                if (data.length > 0) {
                    select.value = data[0].id;
                    this.studentId = data[0].id;
                    document.getElementById('content-container').classList.remove('d-none');
                    document.getElementById('loading-state').classList.add('d-none');
                    this.loadAllData();
                } else {
                    document.getElementById('loading-state').innerHTML = '<div class="alert alert-info">No students found for this parent account.</div>';
                }
            } catch (error) {
                console.error('Error loading students:', error);
                this.showAlert('Failed to load students. Please refresh the page.');
                document.getElementById('loading-state').classList.add('d-none');
            }
        }

        async loadAllData() {
            this.loadFees();
            this.loadPayments();
            this.loadAttendance();
            this.loadExams();
            this.loadNotifications();
        }

        async loadFees() {
            try {
                const response = await fetch(`${this.apiBase}/students/${this.studentId}/fees/`);
                const data = await response.json();

                document.getElementById('fees-loading').classList.add('d-none');
                document.getElementById('fees-content-container').classList.remove('d-none');

                const feesList = document.getElementById('fees-list');
                if (data.length === 0) {
                    feesList.innerHTML = '<p class="text-muted">No fee records found.</p>';
                    return;
                }

                let html = '<div class="table-responsive"><table class="table"><thead><tr><th>Term</th><th>Structure</th><th>Amount</th><th>Status</th></tr></thead><tbody>';
                
                let totalFees = 0;
                let totalPaid = 0;

                data.forEach(fee => {
                    const status = fee.payment_status || 'pending';
                    const badge = status === 'paid' ? 'success' : status === 'partial' ? 'warning' : 'danger';
                    totalFees += parseFloat(fee.amount || 0);
                    if (status === 'paid') totalPaid += parseFloat(fee.amount || 0);

                    html += `
                        <tr>
                            <td>${fee.term || '-'}</td>
                            <td>${fee.fee_structure || '-'}</td>
                            <td>KES ${parseFloat(fee.amount || 0).toLocaleString()}</td>
                            <td><span class="badge bg-${badge}">${status}</span></td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                feesList.innerHTML = html;

                // Update summary
                document.getElementById('total-fees').textContent = `KES ${totalFees.toLocaleString()}`;
                document.getElementById('amount-paid').textContent = `KES ${totalPaid.toLocaleString()}`;
                document.getElementById('outstanding').textContent = `KES ${(totalFees - totalPaid).toLocaleString()}`;

                const statusColor = totalFees === totalPaid ? 'success' : totalPaid > 0 ? 'warning' : 'danger';
                const statusText = totalFees === totalPaid ? 'All Paid' : totalPaid > 0 ? 'Partially Paid' : 'Outstanding';
                document.getElementById('payment-status').innerHTML = `<span class="badge bg-${statusColor}">${statusText}</span>`;

            } catch (error) {
                console.error('Error loading fees:', error);
                document.getElementById('fees-loading').innerHTML = '<p class="text-danger">Failed to load fees.</p>';
            }
        }

        async loadPayments() {
            try {
                const response = await fetch(`${this.apiBase}/students/${this.studentId}/payments/`);
                const data = await response.json();

                document.getElementById('payments-loading').classList.add('d-none');
                document.getElementById('payments-content-container').classList.remove('d-none');

                const tbody = document.getElementById('payments-table');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No payments recorded.</td></tr>';
                    return;
                }

                data.forEach(payment => {
                    const row = `
                        <tr>
                            <td>${new Date(payment.date_paid || payment.created_at).toLocaleDateString()}</td>
                            <td>KES ${parseFloat(payment.amount || 0).toLocaleString()}</td>
                            <td>${payment.reference || payment.mpesa_code || '-'}</td>
                            <td><span class="badge bg-success">${payment.status || 'Completed'}</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading payments:', error);
                document.getElementById('payments-loading').innerHTML = '<p class="text-danger">Failed to load payments.</p>';
            }
        }

        async loadAttendance() {
            try {
                const response = await fetch(`${this.apiBase}/students/${this.studentId}/attendance/`);
                const data = await response.json();

                document.getElementById('attendance-loading').classList.add('d-none');
                document.getElementById('attendance-content-container').classList.remove('d-none');

                const stats = data.stats || data;
                document.getElementById('days-present').textContent = stats.present_days || 0;
                document.getElementById('days-absent').textContent = stats.absent_days || 0;
                document.getElementById('days-total').textContent = stats.total_days || 0;
                document.getElementById('attendance-percent').textContent = stats.attendance_percentage || '0%';

            } catch (error) {
                console.error('Error loading attendance:', error);
                document.getElementById('attendance-loading').innerHTML = '<p class="text-danger">Failed to load attendance.</p>';
            }
        }

        async loadExams() {
            try {
                const response = await fetch(`${this.apiBase}/students/${this.studentId}/exams/`);
                const data = await response.json();

                document.getElementById('exams-loading').classList.add('d-none');
                document.getElementById('exams-content-container').classList.remove('d-none');

                const examsList = document.getElementById('exams-list');
                if (data.length === 0) {
                    examsList.innerHTML = '<p class="text-muted">No exam results available.</p>';
                    return;
                }

                let html = '<div class="table-responsive"><table class="table"><thead><tr><th>Subject</th><th>Exam</th><th>Marks</th><th>Grade</th></tr></thead><tbody>';
                
                data.forEach(exam => {
                    const gradeColor = this.getGradeColor(exam.grade);
                    html += `
                        <tr>
                            <td>${exam.subject || '-'}</td>
                            <td>${exam.exam_name || '-'}</td>
                            <td>${exam.marks || '-'}</td>
                            <td><span class="badge bg-${gradeColor}">${exam.grade || '-'}</span></td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                examsList.innerHTML = html;

            } catch (error) {
                console.error('Error loading exams:', error);
                document.getElementById('exams-loading').innerHTML = '<p class="text-danger">Failed to load exam results.</p>';
            }
        }

        async loadNotifications() {
            try {
                const response = await fetch(`${this.apiBase}/notifications/`);
                const data = await response.json();

                document.getElementById('notifications-loading').classList.add('d-none');
                document.getElementById('notifications-content-container').classList.remove('d-none');

                const notificationsList = document.getElementById('notifications-list');
                if (data.length === 0) {
                    notificationsList.innerHTML = '<p class="text-muted">No notifications yet.</p>';
                    return;
                }

                let html = '';
                data.slice(0, 10).forEach(notification => {
                    const date = new Date(notification.created_at).toLocaleDateString();
                    html += `
                        <div class="alert alert-info mb-2">
                            <h6 class="mb-1">${notification.title || 'Notification'}</h6>
                            <p class="mb-1 small">${notification.message || ''}</p>
                            <small class="text-muted">${date}</small>
                        </div>
                    `;
                });

                notificationsList.innerHTML = html;

            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('notifications-loading').innerHTML = '<p class="text-danger">Failed to load notifications.</p>';
            }
        }

        getGradeColor(grade) {
            const gradeMap = {
                'A': 'success',
                'B': 'success',
                'C': 'warning',
                'D': 'warning',
                'E': 'danger',
                'F': 'danger'
            };
            return gradeMap[grade] || 'secondary';
        }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        new ParentPortalApp();
    });
</script>

<style>
    .nav-link {
        color: #6c757d;
        border: none;
    }

    .nav-link.active {
        color: #0d6efd;
        border-bottom: 3px solid #0d6efd;
    }

    .card {
        transition: box-shadow 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1) !important;
    }

    .badge {
        padding: 0.35rem 0.65rem;
    }

    .spinner-border-sm {
        width: 1.5rem;
        height: 1.5rem;
    }
</style>
{% endblock %}
