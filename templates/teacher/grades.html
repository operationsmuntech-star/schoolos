{% extends 'base.html' %}
{% load static %}

{% block title %}Enter Grades{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="h3 mb-0"><i class="bi bi-pencil-square"></i> Enter Grades</h1>
            <p class="text-muted">Input student marks for exams</p>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container"></div>

    <!-- Exam Selection -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <label for="exam-select" class="form-label">Select Exam</label>
                    <select id="exam-select" class="form-select">
                        <option value="">Choose an exam...</option>
                        {% for exam in exams %}
                        <option value="{{ exam.id }}" {% if selected_exam.id == exam.id %}selected{% endif %}>
                            {{ exam.name }} - {{ exam.student_class.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Grade Entry Form -->
    {% if selected_exam %}
    <div class="row">
        <div class="col-md-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">{{ selected_exam.name }}</h5>
                        <small class="text-muted">{{ selected_exam.student_class.name }} • {{ students|length }} Students</small>
                    </div>
                </div>
                <div class="card-body">
                    {% if students %}
                    <form id="grades-form">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Registration</th>
                                        <th class="text-end">Marks (0-100)</th>
                                        <th class="text-center">Grade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in students %}
                                    <tr>
                                        <td>
                                            <strong>{{ student.user.first_name }} {{ student.user.last_name }}</strong>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ student.registration_number }}</small>
                                        </td>
                                        <td>
                                            <input type="number" 
                                                   class="form-control marks-input" 
                                                   data-student="{{ student.id }}"
                                                   min="0" 
                                                   max="100" 
                                                   step="0.5"
                                                   value="{% if existing_marks|key:student.id %}{{ existing_marks|key:student.id }}{% endif %}"
                                                   placeholder="Enter marks">
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary grade-badge" data-student="{{ student.id }}">—</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                <i class="bi bi-save"></i> Save Grades
                            </button>
                            <a href="{% url 'dashboard:teacher_dashboard' %}" class="btn btn-outline-secondary btn-lg">
                                Cancel
                            </a>
                        </div>
                    </form>
                    {% else %}
                    <p class="text-muted">No students in this class.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        Select an exam above to enter grades
    </div>
    {% endif %}
</div>

<script>
    const examSelect = document.getElementById('exam-select');
    const gradesForm = document.getElementById('grades-form');
    const marksInputs = document.querySelectorAll('.marks-input');

    // Handle exam selection
    examSelect.addEventListener('change', (e) => {
        if (e.target.value) {
            window.location.href = `?exam_id=${e.target.value}`;
        }
    });

    // Calculate grade from marks
    function getGrade(marks) {
        marks = parseFloat(marks);
        if (isNaN(marks) || marks === '') return '—';
        if (marks >= 90) return 'A';
        if (marks >= 80) return 'B';
        if (marks >= 70) return 'C';
        if (marks >= 60) return 'D';
        if (marks >= 50) return 'E';
        return 'F';
    }

    function getGradeColor(grade) {
        const colors = {
            'A': 'success',
            'B': 'success',
            'C': 'warning',
            'D': 'warning',
            'E': 'danger',
            'F': 'danger',
            '—': 'secondary'
        };
        return colors[grade] || 'secondary';
    }

    // Update grade badge on marks change
    marksInputs.forEach(input => {
        input.addEventListener('input', (e) => {
            const marks = e.target.value;
            const studentId = e.target.getAttribute('data-student');
            const grade = getGrade(marks);
            const badge = document.querySelector(`[data-student="${studentId}"].grade-badge`);
            
            if (badge) {
                badge.textContent = grade;
                badge.className = `badge bg-${getGradeColor(grade)} grade-badge`;
            }
        });
    });

    // Initialize grade badges
    marksInputs.forEach(input => {
        const marks = input.value;
        const studentId = input.getAttribute('data-student');
        const grade = getGrade(marks);
        const badge = document.querySelector(`[data-student="${studentId}"].grade-badge`);
        
        if (badge && marks) {
            badge.textContent = grade;
            badge.className = `badge bg-${getGradeColor(grade)} grade-badge`;
        }
    });

    // Handle form submission
    if (gradesForm) {
        gradesForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const examId = '{{ selected_exam.id }}';
            const gradesData = {};

            // Collect grades data
            marksInputs.forEach(input => {
                const studentId = input.getAttribute('data-student');
                const marks = input.value;
                if (marks) {
                    gradesData[studentId] = parseFloat(marks);
                }
            });

            if (Object.keys(gradesData).length === 0) {
                showAlert('✗ Please enter at least one grade', 'warning');
                return;
            }

            try {
                const response = await fetch('{% url "dashboard:save_grades" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken'),
                    },
                    body: JSON.stringify({
                        exam_id: examId,
                        grades: gradesData,
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`✓ ${result.message}`, 'success');
                    if (result.errors && result.errors.length > 0) {
                        result.errors.forEach(error => showAlert(`⚠ ${error}`, 'warning'));
                    }
                    document.getElementById('submit-btn').innerHTML = '<i class="bi bi-check"></i> Saved!';
                    document.getElementById('submit-btn').disabled = true;
                    setTimeout(() => {
                        window.location.href = '{% url "dashboard:teacher_dashboard" %}';
                    }, 2000);
                } else {
                    showAlert(`✗ ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlert(`✗ Error: ${error.message}`, 'danger');
            }
        });
    }

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<style>
    .table-responsive {
        border-radius: 0.5rem;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .marks-input {
        max-width: 150px;
    }

    .marks-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
</style>
{% endblock %}
