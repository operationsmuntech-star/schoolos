<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Login - MunTech Infrastructure</title>
  <link rel="stylesheet" href="../styles/tailwind.css">
  <link rel="stylesheet" href="../styles/base.css">
  <link rel="stylesheet" href="../styles/theme.css">
</head>
<body class="bg-gradient-to-br from-indigo-50 to-blue-50 min-h-screen flex items-center justify-center">
  <div class="container mx-auto max-w-md p-4">
    <!-- Logo/Header -->
    <div class="text-center mb-8">
      <div class="inline-block bg-indigo-600 text-white rounded-full p-4 mb-4">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
        </svg>
      </div>
      <h1 class="text-3xl font-bold text-gray-900">MunTech School</h1>
      <p class="text-gray-600 mt-2">Multi-Tenant Attendance System</p>
    </div>

    <!-- Login Form -->
    <form id="loginForm" class="bg-white rounded-lg shadow-lg p-8">
      <h2 class="text-2xl font-semibold mb-6 text-gray-800">School Login</h2>

      <!-- Error Message -->
      <div id="errorMessage" class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded hidden">
        <span id="errorText"></span>
      </div>

      <!-- School Code / Resolved School -->
      <div class="mb-5" id="schoolBlock">
        <label class="block text-sm font-medium text-gray-700 mb-2">School</label>
        <div id="resolvedSchool" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-800 hidden"></div>
        <input 
          type="text" 
          id="schoolCode" 
          placeholder="e.g., MUNTECH001"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"
          required
        >
        <p class="text-xs text-gray-500 mt-1">Enter your school's unique code or choose it from the landing page</p>
        <div class="mt-2 text-xs text-indigo-600"><a id="changeSchool" href="/">Change school</a></div>
      </div>

      <!-- Username -->
      <div class="mb-5">
        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
        <input 
          type="text" 
          id="username" 
          placeholder="username"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"
          required
        >
      </div>

      <!-- Password -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
        <input 
          type="password" 
          id="password" 
          placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"
          required
        >
      </div>

      <!-- Remember Me -->
      <div class="mb-6 flex items-center">
        <input 
          type="checkbox" 
          id="rememberMe"
          class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
        >
        <label for="rememberMe" class="ml-2 text-sm text-gray-700">Remember me</label>
      </div>

      <!-- Login Button -->
      <button 
        type="submit" 
        id="loginBtn"
        class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition disabled:opacity-50"
      >
        <span id="loginText">Login</span>
        <span id="loadingSpinner" class="hidden">ðŸ”„ Logging in...</span>
      </button>

      <!-- Demo Credentials -->
      <div class="mt-6 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-gray-700">
        <p class="font-semibold mb-1">Demo Credentials:</p>
        <p><strong>School:</strong> MUNTECH001</p>
        <p><strong>Username:</strong> teacher1</p>
        <p><strong>Password:</strong> password</p>
      </div>
    </form>

    <!-- Footer -->
    <div class="text-center mt-6 text-sm text-gray-600">
      <p>Multi-tenant system - Select your school to login</p>
      <p class="mt-2 text-xs text-gray-500">Offline-first attendance tracking for schools</p>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../scripts/auth.js"></script>
  <script src="../scripts/gate.js"></script>
  <script>
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await handleLogin();
    });

    async function handleLogin() {
      // Use resolved school if available
      const resolved = document.getElementById('resolvedSchool');
      const schoolCode = (resolved && !resolved.classList.contains('hidden'))
        ? resolved.dataset.code
        : document.getElementById('schoolCode').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const rememberMe = document.getElementById('rememberMe').checked;

      if (!schoolCode || !username || !password) {
        showError('All fields are required');
        return;
      }

      // Show loading state
      const loginBtn = document.getElementById('loginBtn');
      const loginText = document.getElementById('loginText');
      const spinner = document.getElementById('loadingSpinner');
      
      loginBtn.disabled = true;
      loginText.classList.add('hidden');
      spinner.classList.remove('hidden');

      try {
        const response = await fetch('/api/v1/auth/school-login/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify({
            school_code: schoolCode,
            username: username,
            password: password,
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          showError(error.error || 'Login failed');
          return;
        }

        const data = await response.json();

        // Store tokens
        localStorage.setItem('access_token', data.access);
        localStorage.setItem('refresh_token', data.refresh);
        localStorage.setItem('school_id', data.school.id);
        localStorage.setItem('school_code', data.school.code);
        localStorage.setItem('school_name', data.school.name);
        localStorage.setItem('username', data.user.username);

        if (rememberMe) {
          localStorage.setItem('remember_school', schoolCode);
          localStorage.setItem('remember_username', username);
        }

        // Redirect to attendance
        window.location.href = '/attendance';
      } catch (error) {
        console.error('Login error:', error);
        showError('Network error - please try again');
      } finally {
        loginBtn.disabled = false;
        loginText.classList.remove('hidden');
        spinner.classList.add('hidden');
      }
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      errorText.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }

    // Pre-fill if remembered
    window.addEventListener('DOMContentLoaded', () => {
      // If a school was selected on the gate page, use it and hide the input
      const storedSchoolId = localStorage.getItem('school_id');
      const storedSchoolCode = localStorage.getItem('school_code');
      const storedSchoolName = localStorage.getItem('school_name');

      if (storedSchoolCode) {
        const resolved = document.getElementById('resolvedSchool');
        const input = document.getElementById('schoolCode');
        resolved.textContent = storedSchoolName ? `${storedSchoolName} (${storedSchoolCode})` : storedSchoolCode;
        resolved.dataset.code = storedSchoolCode;
        resolved.classList.remove('hidden');
        input.classList.add('hidden');
      }

      const rememberSchool = localStorage.getItem('remember_school');
      const rememberUsername = localStorage.getItem('remember_username');
      
      if (rememberSchool) {
        document.getElementById('schoolCode').value = rememberSchool;
      }
      if (rememberUsername) {
        document.getElementById('username').value = rememberUsername;
        document.getElementById('rememberMe').checked = true;
      }
    });
  </script>
</body>
</html>
